'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _colors = require('colors');

var _colors2 = _interopRequireDefault(_colors);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Response = function () {
  function Response(validator, emitter) {
    _classCallCheck(this, Response);

    this.emitter = emitter;
    this.validator = validator;
  }

  _createClass(Response, [{
    key: 'accountSetup',
    value: function accountSetup(config, key, secret, flags) {
      var _this = this;

      return function (error, response) {
        _this.validator.response(error, response);
        config.putAndSave({
          'credentials': {
            'api_key': key,
            'api_secret': secret
          }
        }, flags.local);
      };
    }
  }, {
    key: 'accountInfo',
    value: function accountInfo(client) {
      this.emitter.log('API Key:    ' + client.credentials.apiKey + '\nAPI Secret: ' + client.credentials.apiSecret);
    }
  }, {
    key: 'accountBalance',
    value: function accountBalance(error, response) {
      this.validator.response(error, response);
      this.emitter.log(Number(response.value.toFixed(2)) + ' EUR', response.value + ' EUR');
    }

    // Pricing

  }, {
    key: 'priceSms',
    value: function priceSms(error, response) {
      this.validator.response(error, response);
      this.emitter.log(response.price + ' EUR');
    }
  }, {
    key: 'priceVoice',
    value: function priceVoice(error, response) {
      this.validator.response(error, response);
      this.emitter.log(response.price + ' EUR');
    }
  }, {
    key: 'priceCountry',
    value: function priceCountry(error, response) {
      this.validator.response(error, response);
      if (response.networks && this.emitter.amplified) {
        this.emitter.table(response.networks, ['network', 'mtPrice'], ['network', 'mtPrice']);
      } else if (response.mt) {
        var price = this._maxPrice(response);
        this.emitter.log(price + ' EUR');
      } else {
        this.emitter.log('No price found');
      }
    }
  }, {
    key: '_maxPrice',
    value: function _maxPrice(response) {
      var prices = response.networks.map(function (network) {
        return parseFloat(network.mtPrice);
      });
      prices.push(parseFloat(response.mt));
      return Math.max.apply(null, prices);
    }

    // numbers

  }, {
    key: 'numbersList',
    value: function numbersList(flags) {
      var _this2 = this;

      return function (error, response) {
        _this2.validator.response(error, response);
        if (response.numbers && response.numbers.length > 0) {
          _this2.emitter.pagination(flags, response);
          _this2.emitter.table(response.numbers, ['msisdn'], ['msisdn', 'country', 'type', 'features', 'voiceCallbackType', 'voiceCallbackValue', 'moHttpUrl', 'voiceStatusCallbackUrl']);
        } else {
          _this2.emitter.warn('No numbers');
        }
      };
    }
  }, {
    key: 'numberSearch',
    value: function numberSearch(flags) {
      var _this3 = this;

      return function (error, response) {
        _this3.validator.response(error, response);
        if (response.numbers && response.numbers.length > 0) {
          _this3.emitter.pagination(flags, response);
          _this3.emitter.table(response.numbers, ['msisdn'], ['msisdn', 'country', 'cost', 'type', 'features']);
        } else {
          _this3.emitter.warn('No numbers');
        }
      };
    }
  }, {
    key: 'numberBuyFromNumber',
    value: function numberBuyFromNumber(number) {
      var _this4 = this;

      return function (error, response) {
        _this4.validator.response(error, response);
        _this4.emitter.log('Number purchased: ' + number);
      };
    }
  }, {
    key: 'numberBuyFromPattern',
    value: function numberBuyFromPattern(callback) {
      var _this5 = this;

      return function (error, response) {
        _this5.validator.response(error, response);
        if (response.numbers && response.numbers.length > 0) {
          callback(response.numbers[0].msisdn);
        } else {
          _this5.emitter.error('No numbers match your search');
        }
      };
    }
  }, {
    key: 'numberCancel',
    value: function numberCancel(number) {
      var _this6 = this;

      return function (error, response) {
        _this6.validator.response(error, response);
        _this6.emitter.log('Number cancelled: ' + number);
      };
    }
  }, {
    key: 'numberInsight',
    value: function numberInsight(callback) {
      var _this7 = this;

      return function (error, response) {
        _this7.validator.response(error, response);
        callback(response);
      };
    }

    // applications

  }, {
    key: 'applicationsList',
    value: function applicationsList(flags) {
      var _this8 = this;

      return function (error, response) {
        _this8.validator.response(error, response);
        if (response._embedded && response._embedded.applications && response._embedded.applications.length > 0) {
          _this8.emitter.pagination(flags, response);
          _this8.emitter.table(response._embedded.applications, ['id', 'name'], ['id', 'name']);
        } else {
          _this8.emitter.warn('No applications');
        }
      };
    }
  }, {
    key: 'applicationCreate',
    value: function applicationCreate(flags) {
      var _this9 = this;

      return function (error, response) {
        _this9.validator.response(error, response);
        _this9.emitter.list('Application created: ' + response.id, response);
        _this9._writeKey(flags.keyfile, response.keys.private_key);
      };
    }
  }, {
    key: 'applicationShow',
    value: function applicationShow(error, response) {
      this.validator.response(error, response);
      this.emitter.list(null, response);
    }
  }, {
    key: 'applicationUpdate',
    value: function applicationUpdate(error, response) {
      this.validator.response(error, response);
      this.emitter.list('Application updated: ' + response.id, response);
    }
  }, {
    key: 'applicationDelete',
    value: function applicationDelete(error, response) {
      this.validator.response(error, response);
      this.emitter.log('Application deleted');
    }
  }, {
    key: 'applicationNumbers',
    value: function applicationNumbers(app_id, flags) {
      var _this10 = this;

      return function (error, response) {
        _this10.validator.response(error, response);
        if (response.numbers && response.numbers.length > 0) {
          response.numbers = response.numbers.filter(function (number) {
            return number.voiceCallbackValue == app_id;
          });

          _this10.emitter.pagination(flags, response);
          _this10.emitter.table(response.numbers, ['msisdn'], ['msisdn', 'country', 'type', 'features', 'voiceCallbackType', 'voiceCallbackValue', 'moHttpUrl', 'voiceStatusCallbackUrl']);
        } else {
          _this10.emitter.warn('No numbers');
        }
      };
    }

    // links

  }, {
    key: 'numberUpdate',
    value: function numberUpdate(error, response) {
      this.validator.response(error, response);
      this.emitter.log('Number updated');
    }

    // insight

  }, {
    key: 'insightBasic',
    value: function insightBasic(error, response) {
      this.validator.response(error, response);
      this.emitter.list(response.international_format_number + ' | ' + response.country_code, response);
    }
  }, {
    key: 'insightStandard',
    value: function insightStandard(error, response) {
      this.validator.response(error, response);
      this.emitter.list(response.international_format_number + ' | ' + response.country_code + ' | ' + response.current_carrier.name, response);
    }
  }, {
    key: '_writeKey',
    value: function _writeKey(keyfile, private_key) {
      var _this11 = this;

      if (keyfile) {
        _fs2.default.writeFile(keyfile, private_key, function (error) {
          if (error) {
            _this11.emitter.warn(error.message);
            _this11._promptKey(private_key);
          } else {
            _this11.emitter.log('Private Key saved to: ' + keyfile);
          }
        });
      } else {
        this._promptKey(private_key);
      }
    }
  }, {
    key: '_promptKey',
    value: function _promptKey(private_key) {
      this.emitter.log('\nPrivate Key:\n');
      this.emitter.log(_colors2.default.red.bgWhite(private_key + '\n'));
      this.emitter.log('WARNING: You should save this key somewhere safe and secure now, it will not be provided again.');
    }

    // sending messages

  }, {
    key: 'sendSms',
    value: function sendSms(error, response) {
      this.validator.response(error, response);
      var message = response.messages[0];
      this.emitter.log('Message sent to:   ' + message.to + '\nRemaining balance: ' + message['remaining-balance'] + ' EUR\nMessage price:     ' + message['message-price'] + ' EUR');
    }

    // JWT

  }, {
    key: 'generateJwt',
    value: function generateJwt(error, token) {
      this.validator.response(error, token);
      this.emitter.log('' + token, 'JWT:   ' + token);
    }
  }]);

  return Response;
}();

exports.default = Response;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXNwb25zZS5qcyJdLCJuYW1lcyI6WyJSZXNwb25zZSIsInZhbGlkYXRvciIsImVtaXR0ZXIiLCJjb25maWciLCJrZXkiLCJzZWNyZXQiLCJmbGFncyIsImVycm9yIiwicmVzcG9uc2UiLCJwdXRBbmRTYXZlIiwibG9jYWwiLCJjbGllbnQiLCJsb2ciLCJjcmVkZW50aWFscyIsImFwaUtleSIsImFwaVNlY3JldCIsIk51bWJlciIsInZhbHVlIiwidG9GaXhlZCIsInByaWNlIiwibmV0d29ya3MiLCJhbXBsaWZpZWQiLCJ0YWJsZSIsIm10IiwiX21heFByaWNlIiwicHJpY2VzIiwibWFwIiwibmV0d29yayIsInBhcnNlRmxvYXQiLCJtdFByaWNlIiwicHVzaCIsIk1hdGgiLCJtYXgiLCJhcHBseSIsIm51bWJlcnMiLCJsZW5ndGgiLCJwYWdpbmF0aW9uIiwid2FybiIsIm51bWJlciIsImNhbGxiYWNrIiwibXNpc2RuIiwiX2VtYmVkZGVkIiwiYXBwbGljYXRpb25zIiwibGlzdCIsImlkIiwiX3dyaXRlS2V5Iiwia2V5ZmlsZSIsImtleXMiLCJwcml2YXRlX2tleSIsImFwcF9pZCIsImZpbHRlciIsInZvaWNlQ2FsbGJhY2tWYWx1ZSIsImludGVybmF0aW9uYWxfZm9ybWF0X251bWJlciIsImNvdW50cnlfY29kZSIsImN1cnJlbnRfY2FycmllciIsIm5hbWUiLCJ3cml0ZUZpbGUiLCJtZXNzYWdlIiwiX3Byb21wdEtleSIsInJlZCIsImJnV2hpdGUiLCJtZXNzYWdlcyIsInRvIiwidG9rZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7Ozs7Ozs7SUFFTUEsUTtBQUNKLG9CQUFZQyxTQUFaLEVBQXVCQyxPQUF2QixFQUFnQztBQUFBOztBQUM5QixTQUFLQSxPQUFMLEdBQWVBLE9BQWY7QUFDQSxTQUFLRCxTQUFMLEdBQWlCQSxTQUFqQjtBQUNEOzs7O2lDQUVZRSxNLEVBQVFDLEcsRUFBS0MsTSxFQUFRQyxLLEVBQU87QUFB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LG1CQUFSLENBRGpCLGlDQUVpQkEsUUFBUSxlQUFSLENBRmpCO0FBR0Q7O0FBRUQ7Ozs7Z0NBRVlsRCxLLEVBQU93RCxLLEVBQU87QUFDeEIsV0FBSzlELFNBQUwsQ0FBZU8sUUFBZixDQUF3QkQsS0FBeEIsRUFBK0J3RCxLQUEvQjtBQUNBLFdBQUs3RCxPQUFMLENBQWFVLEdBQWIsTUFBb0JtRCxLQUFwQixjQUF1Q0EsS0FBdkM7QUFDRDs7Ozs7O2tCQUdZL0QsUSIsImZpbGUiOiJyZXNwb25zZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjb2xvcnMgZnJvbSAnY29sb3JzJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5cbmNsYXNzIFJlc3BvbnNlIHtcbiAgY29uc3RydWN0b3IodmFsaWRhdG9yLCBlbWl0dGVyKSB7XG4gICAgdGhpcy5lbWl0dGVyID0gZW1pdHRlcjtcbiAgICB0aGlzLnZhbGlkYXRvciA9IHZhbGlkYXRvcjtcbiAgfVxuXG4gIGFjY291bnRTZXR1cChjb25maWcsIGtleSwgc2VjcmV0LCBmbGFncykge1xuICAgIHJldHVybiAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgICAgY29uZmlnLnB1dEFuZFNhdmUoe1xuICAgICAgICAnY3JlZGVudGlhbHMnOiB7XG4gICAgICAgICAgJ2FwaV9rZXknOiBrZXksXG4gICAgICAgICAgJ2FwaV9zZWNyZXQnOiBzZWNyZXRcbiAgICAgICAgfVxuICAgICAgfSwgZmxhZ3MubG9jYWwpO1xuICAgIH07XG4gIH1cblxuICBhY2NvdW50SW5mbyhjbGllbnQpIHtcbiAgICB0aGlzLmVtaXR0ZXIubG9nKFxuYEFQSSBLZXk6ICAgICR7Y2xpZW50LmNyZWRlbnRpYWxzLmFwaUtleX1cbkFQSSBTZWNyZXQ6ICR7Y2xpZW50LmNyZWRlbnRpYWxzLmFwaVNlY3JldH1gXG4gICAgKTtcbiAgfVxuXG4gIGFjY291bnRCYWxhbmNlKGVycm9yLCByZXNwb25zZSkge1xuICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgdGhpcy5lbWl0dGVyLmxvZyhcbiAgICAgIGAke051bWJlcigocmVzcG9uc2UudmFsdWUpLnRvRml4ZWQoMikpfSBFVVJgLFxuICAgICAgYCR7cmVzcG9uc2UudmFsdWV9IEVVUmBcbiAgICApO1xuICB9XG5cbiAgLy8gUHJpY2luZ1xuXG4gIHByaWNlU21zKGVycm9yLCByZXNwb25zZSkge1xuICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgdGhpcy5lbWl0dGVyLmxvZyhgJHtyZXNwb25zZS5wcmljZX0gRVVSYCk7XG4gIH1cblxuICBwcmljZVZvaWNlKGVycm9yLCByZXNwb25zZSkge1xuICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgdGhpcy5lbWl0dGVyLmxvZyhgJHtyZXNwb25zZS5wcmljZX0gRVVSYCk7XG4gIH1cblxuICBwcmljZUNvdW50cnkoZXJyb3IsIHJlc3BvbnNlKSB7XG4gICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICBpZiAocmVzcG9uc2UubmV0d29ya3MgJiYgdGhpcy5lbWl0dGVyLmFtcGxpZmllZCkge1xuICAgICAgdGhpcy5lbWl0dGVyLnRhYmxlKHJlc3BvbnNlLm5ldHdvcmtzLCBbJ25ldHdvcmsnLCAnbXRQcmljZSddLCBbJ25ldHdvcmsnLCAnbXRQcmljZSddKTtcbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLm10KSB7XG4gICAgICBsZXQgcHJpY2UgPSB0aGlzLl9tYXhQcmljZShyZXNwb25zZSk7XG4gICAgICB0aGlzLmVtaXR0ZXIubG9nKGAke3ByaWNlfSBFVVJgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5lbWl0dGVyLmxvZygnTm8gcHJpY2UgZm91bmQnKTtcbiAgICB9XG4gIH1cblxuICBfbWF4UHJpY2UocmVzcG9uc2UpIHtcbiAgICBsZXQgcHJpY2VzID0gcmVzcG9uc2UubmV0d29ya3MubWFwKChuZXR3b3JrKSA9PiB7XG4gICAgICByZXR1cm4gcGFyc2VGbG9hdChuZXR3b3JrLm10UHJpY2UpO1xuICAgIH0pO1xuICAgIHByaWNlcy5wdXNoKHBhcnNlRmxvYXQocmVzcG9uc2UubXQpKTtcbiAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkobnVsbCwgcHJpY2VzKTtcbiAgfVxuXG4gIC8vIG51bWJlcnNcblxuICBudW1iZXJzTGlzdChmbGFncykge1xuICAgIHJldHVybiAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgICAgaWYgKHJlc3BvbnNlLm51bWJlcnMgJiYgcmVzcG9uc2UubnVtYmVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMuZW1pdHRlci5wYWdpbmF0aW9uKGZsYWdzLCByZXNwb25zZSk7XG4gICAgICAgIHRoaXMuZW1pdHRlci50YWJsZShyZXNwb25zZS5udW1iZXJzLCBbJ21zaXNkbiddLCBbJ21zaXNkbicsICdjb3VudHJ5JywgJ3R5cGUnLCAnZmVhdHVyZXMnLCAndm9pY2VDYWxsYmFja1R5cGUnLCAndm9pY2VDYWxsYmFja1ZhbHVlJywgJ21vSHR0cFVybCcsICd2b2ljZVN0YXR1c0NhbGxiYWNrVXJsJ10pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5lbWl0dGVyLndhcm4oJ05vIG51bWJlcnMnKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgbnVtYmVyU2VhcmNoKGZsYWdzKSB7XG4gICAgcmV0dXJuIChlcnJvciwgcmVzcG9uc2UpID0+IHtcbiAgICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgICBpZiAocmVzcG9uc2UubnVtYmVycyAmJiByZXNwb25zZS5udW1iZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhpcy5lbWl0dGVyLnBhZ2luYXRpb24oZmxhZ3MsIHJlc3BvbnNlKTtcbiAgICAgICAgdGhpcy5lbWl0dGVyLnRhYmxlKHJlc3BvbnNlLm51bWJlcnMsIFsnbXNpc2RuJ10sIFsnbXNpc2RuJywgJ2NvdW50cnknLCAnY29zdCcsICd0eXBlJywgJ2ZlYXR1cmVzJ10pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5lbWl0dGVyLndhcm4oJ05vIG51bWJlcnMnKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgbnVtYmVyQnV5RnJvbU51bWJlcihudW1iZXIpIHtcbiAgICByZXR1cm4gKGVycm9yLCByZXNwb25zZSkgPT4ge1xuICAgICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICAgIHRoaXMuZW1pdHRlci5sb2coYE51bWJlciBwdXJjaGFzZWQ6ICR7bnVtYmVyfWApO1xuICAgIH07XG4gIH1cblxuICBudW1iZXJCdXlGcm9tUGF0dGVybihjYWxsYmFjaykge1xuICAgIHJldHVybiAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgICAgaWYgKHJlc3BvbnNlLm51bWJlcnMgJiYgcmVzcG9uc2UubnVtYmVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNhbGxiYWNrKHJlc3BvbnNlLm51bWJlcnNbMF0ubXNpc2RuKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZW1pdHRlci5lcnJvcignTm8gbnVtYmVycyBtYXRjaCB5b3VyIHNlYXJjaCcpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBudW1iZXJDYW5jZWwobnVtYmVyKSB7XG4gICAgcmV0dXJuIChlcnJvciwgcmVzcG9uc2UpID0+IHtcbiAgICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgICB0aGlzLmVtaXR0ZXIubG9nKGBOdW1iZXIgY2FuY2VsbGVkOiAke251bWJlcn1gKTtcbiAgICB9O1xuICB9XG5cbiAgbnVtYmVySW5zaWdodChjYWxsYmFjaykge1xuICAgIHJldHVybiAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgICAgY2FsbGJhY2socmVzcG9uc2UpO1xuICAgIH07XG4gIH1cblxuICAvLyBhcHBsaWNhdGlvbnNcblxuICBhcHBsaWNhdGlvbnNMaXN0KGZsYWdzKSB7XG4gICAgcmV0dXJuIChlcnJvciwgcmVzcG9uc2UpID0+IHtcbiAgICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgICBpZiAocmVzcG9uc2UuX2VtYmVkZGVkICYmIHJlc3BvbnNlLl9lbWJlZGRlZC5hcHBsaWNhdGlvbnMgJiYgcmVzcG9uc2UuX2VtYmVkZGVkLmFwcGxpY2F0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMuZW1pdHRlci5wYWdpbmF0aW9uKGZsYWdzLCByZXNwb25zZSk7XG4gICAgICAgIHRoaXMuZW1pdHRlci50YWJsZShyZXNwb25zZS5fZW1iZWRkZWQuYXBwbGljYXRpb25zLCBbJ2lkJywgJ25hbWUnXSwgWydpZCcsICduYW1lJ10pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5lbWl0dGVyLndhcm4oJ05vIGFwcGxpY2F0aW9ucycpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBhcHBsaWNhdGlvbkNyZWF0ZShmbGFncykge1xuICAgIHJldHVybiAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgICAgdGhpcy5lbWl0dGVyLmxpc3QoYEFwcGxpY2F0aW9uIGNyZWF0ZWQ6ICR7cmVzcG9uc2UuaWR9YCwgcmVzcG9uc2UpO1xuICAgICAgdGhpcy5fd3JpdGVLZXkoZmxhZ3Mua2V5ZmlsZSwgcmVzcG9uc2Uua2V5cy5wcml2YXRlX2tleSk7XG4gICAgfTtcbiAgfVxuXG4gIGFwcGxpY2F0aW9uU2hvdyhlcnJvciwgcmVzcG9uc2UpIHtcbiAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgIHRoaXMuZW1pdHRlci5saXN0KG51bGwsIHJlc3BvbnNlKTtcbiAgfVxuXG4gIGFwcGxpY2F0aW9uVXBkYXRlKGVycm9yLCByZXNwb25zZSkge1xuICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgdGhpcy5lbWl0dGVyLmxpc3QoYEFwcGxpY2F0aW9uIHVwZGF0ZWQ6ICR7cmVzcG9uc2UuaWR9YCwgcmVzcG9uc2UpO1xuICB9XG5cbiAgYXBwbGljYXRpb25EZWxldGUoZXJyb3IsIHJlc3BvbnNlKSB7XG4gICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICB0aGlzLmVtaXR0ZXIubG9nKCdBcHBsaWNhdGlvbiBkZWxldGVkJyk7XG4gIH1cblxuICBhcHBsaWNhdGlvbk51bWJlcnMoYXBwX2lkLCBmbGFncykge1xuICAgIHJldHVybiAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgICAgaWYgKHJlc3BvbnNlLm51bWJlcnMgJiYgcmVzcG9uc2UubnVtYmVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJlc3BvbnNlLm51bWJlcnMgPSByZXNwb25zZS5udW1iZXJzLmZpbHRlcigobnVtYmVyKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIG51bWJlci52b2ljZUNhbGxiYWNrVmFsdWUgPT0gYXBwX2lkO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmVtaXR0ZXIucGFnaW5hdGlvbihmbGFncywgcmVzcG9uc2UpO1xuICAgICAgICB0aGlzLmVtaXR0ZXIudGFibGUocmVzcG9uc2UubnVtYmVycywgWydtc2lzZG4nXSwgWydtc2lzZG4nLCAnY291bnRyeScsICd0eXBlJywgJ2ZlYXR1cmVzJywgJ3ZvaWNlQ2FsbGJhY2tUeXBlJywgJ3ZvaWNlQ2FsbGJhY2tWYWx1ZScsICdtb0h0dHBVcmwnLCAndm9pY2VTdGF0dXNDYWxsYmFja1VybCddKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZW1pdHRlci53YXJuKCdObyBudW1iZXJzJyk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8vIGxpbmtzXG5cbiAgbnVtYmVyVXBkYXRlKGVycm9yLCByZXNwb25zZSkge1xuICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgdGhpcy5lbWl0dGVyLmxvZygnTnVtYmVyIHVwZGF0ZWQnKTtcbiAgfVxuXG4gIC8vIGluc2lnaHRcblxuICBpbnNpZ2h0QmFzaWMoZXJyb3IsIHJlc3BvbnNlKSB7XG4gICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlKTtcbiAgICB0aGlzLmVtaXR0ZXIubGlzdChgJHtyZXNwb25zZS5pbnRlcm5hdGlvbmFsX2Zvcm1hdF9udW1iZXJ9IHwgJHtyZXNwb25zZS5jb3VudHJ5X2NvZGV9YCwgcmVzcG9uc2UpO1xuICB9XG5cbiAgaW5zaWdodFN0YW5kYXJkKGVycm9yLCByZXNwb25zZSkge1xuICAgIHRoaXMudmFsaWRhdG9yLnJlc3BvbnNlKGVycm9yLCByZXNwb25zZSk7XG4gICAgdGhpcy5lbWl0dGVyLmxpc3QoYCR7cmVzcG9uc2UuaW50ZXJuYXRpb25hbF9mb3JtYXRfbnVtYmVyfSB8ICR7cmVzcG9uc2UuY291bnRyeV9jb2RlfSB8ICR7cmVzcG9uc2UuY3VycmVudF9jYXJyaWVyLm5hbWV9YCwgcmVzcG9uc2UpO1xuICB9XG5cbiAgX3dyaXRlS2V5KGtleWZpbGUsIHByaXZhdGVfa2V5KSB7XG4gICAgaWYgKGtleWZpbGUpIHtcbiAgICAgIGZzLndyaXRlRmlsZShrZXlmaWxlLCBwcml2YXRlX2tleSwgKGVycm9yKSA9PiB7XG4gICAgICAgIGlmKGVycm9yKSB7XG4gICAgICAgICAgdGhpcy5lbWl0dGVyLndhcm4oZXJyb3IubWVzc2FnZSk7XG4gICAgICAgICAgdGhpcy5fcHJvbXB0S2V5KHByaXZhdGVfa2V5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmVtaXR0ZXIubG9nKGBQcml2YXRlIEtleSBzYXZlZCB0bzogJHtrZXlmaWxlfWApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fcHJvbXB0S2V5KHByaXZhdGVfa2V5KTtcbiAgICB9XG4gIH1cblxuICBfcHJvbXB0S2V5KHByaXZhdGVfa2V5KSB7XG4gICAgdGhpcy5lbWl0dGVyLmxvZygnXFxuUHJpdmF0ZSBLZXk6XFxuJyk7XG4gICAgdGhpcy5lbWl0dGVyLmxvZyhjb2xvcnMucmVkLmJnV2hpdGUoYCR7cHJpdmF0ZV9rZXl9XFxuYCkpO1xuICAgIHRoaXMuZW1pdHRlci5sb2coJ1dBUk5JTkc6IFlvdSBzaG91bGQgc2F2ZSB0aGlzIGtleSBzb21ld2hlcmUgc2FmZSBhbmQgc2VjdXJlIG5vdywgaXQgd2lsbCBub3QgYmUgcHJvdmlkZWQgYWdhaW4uJyk7XG4gIH1cblxuICAvLyBzZW5kaW5nIG1lc3NhZ2VzXG5cbiAgc2VuZFNtcyhlcnJvciwgcmVzcG9uc2UpIHtcbiAgICB0aGlzLnZhbGlkYXRvci5yZXNwb25zZShlcnJvciwgcmVzcG9uc2UpO1xuICAgIGNvbnN0IG1lc3NhZ2UgPSByZXNwb25zZS5tZXNzYWdlc1swXTtcbiAgICB0aGlzLmVtaXR0ZXIubG9nKGBNZXNzYWdlIHNlbnQgdG86ICAgJHttZXNzYWdlLnRvfVxuUmVtYWluaW5nIGJhbGFuY2U6ICR7bWVzc2FnZVsncmVtYWluaW5nLWJhbGFuY2UnXX0gRVVSXG5NZXNzYWdlIHByaWNlOiAgICAgJHttZXNzYWdlWydtZXNzYWdlLXByaWNlJ119IEVVUmApO1xuICB9XG5cbiAgLy8gSldUXG5cbiAgZ2VuZXJhdGVKd3QoZXJyb3IsIHRva2VuKSB7XG4gICAgdGhpcy52YWxpZGF0b3IucmVzcG9uc2UoZXJyb3IsIHRva2VuKTtcbiAgICB0aGlzLmVtaXR0ZXIubG9nKGAke3Rva2VufWAsIGBKV1Q6ICAgJHt0b2tlbn1gKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBSZXNwb25zZTtcbiJdfQ==