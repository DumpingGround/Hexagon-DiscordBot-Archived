'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _readline = require('readline');

var _readline2 = _interopRequireDefault(_readline);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Request = function () {
  function Request(config, client, response) {
    _classCallCheck(this, Request);

    this.config = config;
    this.client = client;
    this.response = response;
  }
  // Account

  _createClass(Request, [{
    key: 'accountSetup',
    value: function accountSetup(key, secret, flags) {
      this._verifyCredentials(key, secret, this.response.accountSetup(this.config, key, secret, flags).bind(this.response));
    }
  }, {
    key: '_verifyCredentials',
    value: function _verifyCredentials(key, secret, callback) {
      var client = this.client.instanceWith(key, secret);
      client.account.checkBalance(callback);
    }
  }, {
    key: 'accountInfo',
    value: function accountInfo() {
      this.response.accountInfo(this.client.instance());
    }
  }, {
    key: 'accountBalance',
    value: function accountBalance() {
      this.client.instance().account.checkBalance(this.response.accountBalance.bind(this.response));
    }

    // Pricing

  }, {
    key: 'priceSms',
    value: function priceSms(number) {
      number = stripPlus(number);
      this.client.instance().number.getPhonePricing('sms', number, this.response.priceSms.bind(this.response));
    }
  }, {
    key: 'priceVoice',
    value: function priceVoice(number) {
      number = stripPlus(number);
      this.client.instance().number.getPhonePricing('voice', number, this.response.priceVoice.bind(this.response));
    }
  }, {
    key: 'priceCountry',
    value: function priceCountry(country_code) {
      this.client.instance().number.getPricing(country_code, this.response.priceCountry.bind(this.response));
    }

    // Numbers

  }, {
    key: 'numbersList',
    value: function numbersList(flags) {
      var options = { size: 100 };
      if (flags.page) {
        options.index = flags.page;
      }
      if (flags.size) {
        options.size = flags.size;
      }

      if (flags.pattern) {
        options.pattern = flags.pattern;
        options.search_pattern = 1;
        if (options.pattern[0] === '*') options.search_pattern = 2;
        if (options.pattern.slice(-1) === '*') options.search_pattern = 0;
      }

      this.client.instance().number.get(options, this.response.numbersList(flags).bind(this.response));
    }
  }, {
    key: 'numberSearch',
    value: function numberSearch(country_code, flags) {
      country_code = country_code.toUpperCase();

      var options = { features: [], size: 100 };
      if (flags.voice) {
        options.features.push('VOICE');
      }
      if (flags.sms) {
        options.features.push('SMS');
      }
      if (flags.page) {
        options.index = flags.page;
      }
      if (flags.size) {
        options.size = flags.size;
      }

      if (flags.pattern) {
        options.pattern = flags.pattern;
        options.search_pattern = 1;
        if (options.pattern[0] === '*') options.search_pattern = 2;
        if (options.pattern.slice(-1) === '*') options.search_pattern = 0;
      }

      this.client.instance().number.search(country_code, options, this.response.numberSearch(flags).bind(this.response));
    }
  }, {
    key: 'numberBuy',
    value: function numberBuy(numberOrPattern, command) {
      if (command.country_code) {
        this.numberBuyFromSearch(command.country_code, numberOrPattern, command);
      } else {
        this.numberBuyFromNumber(numberOrPattern, command);
      }
    }
  }, {
    key: 'numberBuyFromNumber',
    value: function numberBuyFromNumber(number, flags) {
      var _this = this;

      number = stripPlus(number);
      confirm('Buying ' + number + '. This operation will charge your account.', this.response.emitter, flags, function () {
        _this.getCountryCode(number, flags, function (country_code) {
          _this.client.instance().number.buy(country_code, number, _this.response.numberBuyFromNumber(number).bind(_this.response));
        });
      });
    }
  }, {
    key: 'numberBuyFromSearch',
    value: function numberBuyFromSearch(country_code, pattern, flags) {
      var _this2 = this;

      var options = { features: ['VOICE'] };

      if (pattern) {
        options.pattern = pattern;
        options.search_pattern = 1;
        if (pattern[0] === '*') options.search_pattern = 2;
        if (pattern.slice(-1) === '*') options.search_pattern = 0;
      }

      this.client.instance().number.search(country_code, options, this.response.numberBuyFromPattern(function (number) {
        _this2.numberBuyFromNumber(number, flags);
      }));
    }
  }, {
    key: 'numberCancel',
    value: function numberCancel(number, flags) {
      var _this3 = this;

      confirm('This operation can not be reversed.', this.response.emitter, flags, function () {
        _this3.getCountryCode(number, flags, function (country_code) {
          _this3.client.instance().number.cancel(country_code, number, _this3.response.numberCancel(number).bind(_this3.response));
        });
      });
    }

    // Applications

  }, {
    key: 'applicationsList',
    value: function applicationsList(flags) {
      var options = { page_size: 100 };
      if (flags.page) {
        options.index = flags.page;
      }
      if (flags.size) {
        options.page_size = flags.size;
      }

      this.client.instance().app.get(options, this.response.applicationsList(flags).bind(this.response));
    }
  }, {
    key: 'applicationCreate',
    value: function applicationCreate(name, answer_url, event_url, flags) {
      var options = {};
      if (flags.answer_method) {
        options.answer_method = flags.answer_method;
      }
      if (flags.event_method) {
        options.event_method = flags.event_method;
      }

      this.client.instance().app.create(name, flags.type, answer_url, event_url, options, this.response.applicationCreate(flags));
    }
  }, {
    key: 'applicationShow',
    value: function applicationShow(app_id) {
      this.client.instance().app.get(app_id, this.response.applicationShow.bind(this.response));
    }
  }, {
    key: 'applicationUpdate',
    value: function applicationUpdate(app_id, name, answer_url, event_url, flags) {
      var options = {};
      if (flags.answer_method) {
        options.answer_method = flags.answer_method;
      }
      if (flags.event_method) {
        options.event_method = flags.event_method;
      }

      this.client.instance().app.update(app_id, name, flags.type, answer_url, event_url, options, this.response.applicationUpdate.bind(this.response));
    }
  }, {
    key: 'applicationDelete',
    value: function applicationDelete(app_id, flags) {
      var _this4 = this;

      return confirm('This operation can not be reversed.', this.response.emitter, flags, function () {
        _this4.client.instance().app.delete(app_id, _this4.response.applicationDelete.bind(_this4.response));
      });
    }
  }, {
    key: 'applicationNumbers',
    value: function applicationNumbers(app_id, flags) {
      var options = {};
      if (flags.page) {
        options.index = flags.page;
      }
      if (flags.size) {
        options.size = flags.size;
      }

      this.client.instance().number.get(options, this.response.applicationNumbers(app_id, flags).bind(this.response));
    }

    // links

  }, {
    key: 'linkApp',
    value: function linkApp(number, app_id, flags) {
      this._link(number, flags, null, 'app', app_id);
    }
  }, {
    key: 'linkSms',
    value: function linkSms(number, callback_url, flags) {
      this._link(number, flags, callback_url, 'sms', null);
    }
  }, {
    key: 'linkTel',
    value: function linkTel(number, other_number, flags) {
      this._link(number, flags, null, 'tel', other_number, flags.voice_status_callback);
    }
  }, {
    key: 'linkSip',
    value: function linkSip(number, sip_uri, flags) {
      this._link(number, flags, null, 'sip', sip_uri, flags.voice_status_callback);
    }
  }, {
    key: 'linkVxml',
    value: function linkVxml(number, calback_url, flags) {
      this._link(number, flags, null, 'vxml', calback_url, flags.voice_status_callback);
    }
  }, {
    key: 'unlinkApp',
    value: function unlinkApp(number, flags) {
      this._link(number, flags, null, 'app');
    }
  }, {
    key: 'unlinkSms',
    value: function unlinkSms(number, flags) {
      this._link(number, flags, '', 'sms');
    }
  }, {
    key: 'unlinkTel',
    value: function unlinkTel(number, flags) {
      this._link(number, flags, null, 'tel');
    }
  }, {
    key: 'unlinkSip',
    value: function unlinkSip(number, flags) {
      this._link(number, flags, null, 'sip');
    }
  }, {
    key: 'unlinkVxml',
    value: function unlinkVxml(number, flags) {
      this._link(number, flags, null, 'vxml');
    }
  }, {
    key: 'numberUpdate',
    value: function numberUpdate(number, flags) {
      var _this5 = this;

      number = stripPlus(number);
      this.getCountryCode(number, flags, function (country_code) {
        var options = {};
        if (flags.mo_http_url) options.moHttpUrl = flags.mo_http_url;
        if (flags.voice_callback_type) options.voiceCallbackType = flags.voice_callback_type;
        if (flags.voice_callback_value) options.voiceCallbackValue = flags.voice_callback_value;
        if (flags.voice_status_callback) options.voiceStatusCallback = flags.voice_status_callback;
        _this5.client.instance().number.update(country_code, number, options, _this5.response.numberUpdate.bind(_this5.response));
      });
    }
  }, {
    key: '_link',
    value: function _link(number, flags, mo_http_url, voice_callback_type, voice_callback_value, voice_status_callback) {
      var _this6 = this;

      if (flags == null) {
        flags = {};
      }
      number = stripPlus(number);
      this.getCountryCode(number, flags, function (country_code) {
        var options = {};

        if (voice_callback_type == 'sms') {
          options.moHttpUrl = mo_http_url;
        } else {
          options.voiceCallbackType = voice_callback_type;
          if (voice_callback_value) options.voiceCallbackValue = voice_callback_value;
          if (voice_status_callback) options.voiceStatusCallback = voice_status_callback;
        }

        _this6.client.instance().number.update(country_code, number, options, _this6.response.numberUpdate.bind(_this6.response));
      });
    }

    // Insight

  }, {
    key: 'insightBasic',
    value: function insightBasic(number) {
      number = stripPlus(number);
      this.client.instance().numberInsight.get({ level: 'basic', number: number }, this.response.insightBasic.bind(this.response));
    }
  }, {
    key: 'insightStandard',
    value: function insightStandard(number, flags) {
      var _this7 = this;

      number = stripPlus(number);
      confirm('This operation will charge your account.', this.response.emitter, flags, function () {
        _this7.client.instance().numberInsight.get({ level: 'standard', number: number }, _this7.response.insightStandard.bind(_this7.response));
      });
    }
  }, {
    key: 'insightAdvanced',
    value: function insightAdvanced(number, flags) {
      var _this8 = this;

      number = stripPlus(number);
      confirm('This operation will charge your account.', this.response.emitter, flags, function () {
        _this8.client.instance().numberInsight.get({ level: 'advancedSync', number: number }, _this8.response.insightStandard.bind(_this8.response));
      });
    }

    // sending messages

  }, {
    key: 'sendSms',
    value: function sendSms(to, text, flags) {
      var _this9 = this;

      confirm('This operation will charge your account.', this.response.emitter, flags, function () {
        _this9.client.instance().message.sendSms(flags.from, to, text.join(' '), _this9.response.sendSms.bind(_this9.response));
      });
    }
  }, {
    key: 'generateJwt',
    value: function generateJwt(privateKey, claims, flags) {
      var token = null;
      var error = null;

      try {
        var fullClaims = {};
        if (flags.app_id) {
          fullClaims['application_id'] = flags.app_id;
        }

        claims.forEach(function (claim) {
          var nameValue = claim.split('=');
          if (nameValue.length !== 2) {
            throw new Error('All claims must be in the form `name=value`. Got: ' + nameValue);
          }
          fullClaims[nameValue[0]] = nameValue[1];
        });

        token = this.client.definition().generateJwt(privateKey, fullClaims);
      } catch (ex) {
        error = ex;
      }
      this.response.generateJwt(error, token);
    }
  }, {
    key: 'getCountryCode',
    value: function getCountryCode(number, flags, callback) {
      if (flags.country_code) {
        callback(flags.country_code);
      } else {
        this.client.instance().numberInsight.get({ level: 'basic', number: number }, this.response.numberInsight(function (response) {
          callback(response.country_code);
        }));
      }
    }
  }]);

  return Request;
}();

exports.default = Request;

// private methods

var confirm = function confirm(message, emitter, flags, callback) {
  if (flags.confirm) {
    callback();
  } else {
    var cli = _readline2.default.createInterface(process.stdin, process.stdout);
    cli.question(message + '\n\nPlease type "confirm" to continue: ', function (answer) {
      if (answer.toString().trim() == 'confirm') {
        emitter.log(' ');
        callback();
      } else {
        process.exit(1);
      }

      cli.close();
      process.stdin.destroy();
    });
  }
};

var stripPlus = function stripPlus(number) {
  if (!number) {
    return number;
  }
  while (number.charAt(0) === '+') {
    number = number.substr(1);
  }
  return number;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXF1ZXN0LmpzIl0sIm5hbWVzIjpbIlJlcXVlc3QiLCJjb25maWciLCJjbGllbnQiLCJyZXNwb25zZSIsImtleSIsInNlY3JldCIsImZsYWdzIiwiX3ZlcmlmeUNyZWRlbnRpYWxzIiwiYWNjb3VudFNldHVwIiwiYmluZCIsImNhbGxiYWNrIiwiaW5zdGFuY2VXaXRoIiwiYWNjb3VudCIsImNoZWNrQmFsYW5jZSIsImFjY291bnRJbmZvIiwiaW5zdGFuY2UiLCJhY2NvdW50QmFsYW5jZSIsIm51bWJlciIsInN0cmlwUGx1cyIsImdldFBob25lUHJpY2luZyIsInByaWNlU21zIiwicHJpY2VWb2ljZSIsImNvdW50cnlfY29kZSIsImdldFByaWNpbmciLCJwcmljZUNvdW50cnkiLCJvcHRpb25zIiwic2l6ZSIsInBhZ2UiLCJpbmRleCIsInBhdHRlcm4iLCJzZWFyY2hfcGF0dGVybiIsInNsaWNlIiwiZ2V0IiwibnVtYmVyc0xpc3QiLCJ0b1VwcGVyQ2FzZSIsImZlYXR1cmVzIiwidm9pY2UiLCJwdXNoIiwic21zIiwic2VhcmNoIiwibnVtYmVyU2VhcmNoIiwibnVtYmVyT3JQYXR0ZXJuIiwiY29tbWFuZCIsIm51bWJlckJ1eUZyb21TZWFyY2giLCJudW1iZXJCdXlGcm9tTnVtYmVyIiwiY29uZmlybSIsImVtaXR0ZXIiLCJnZXRDb3VudHJ5Q29kZSIsImJ1eSIsIm51bWJlckJ1eUZyb21QYXR0ZXJuIiwiY2FuY2VsIiwibnVtYmVyQ2FuY2VsIiwicGFnZV9zaXplIiwiYXBwIiwiYXBwbGljYXRpb25zTGlzdCIsIm5hbWUiLCJhbnN3ZXJfdXJsIiwiZXZlbnRfdXJsIiwiYW5zd2VyX21ldGhvZCIsImV2ZW50X21ldGhvZCIsImNyZWF0ZSIsInR5cGUiLCJhcHBsaWNhdGlvbkNyZWF0ZSIsImFwcF9pZCIsImFwcGxpY2F0aW9uU2hvdyIsInVwZGF0ZSIsImFwcGxpY2F0aW9uVXBkYXRlIiwiZGVsZXRlIiwiYXBwbGljYXRpb25EZWxldGUiLCJhcHBsaWNhdGlvbk51bWJlcnMiLCJfbGluayIsImNhbGxiYWNrX3VybCIsIm90aGVyX251bWJlciIsInZvaWNlX3N0YXR1c19jYWxsYmFjayIsInNpcF91cmkiLCJjYWxiYWNrX3VybCIsIm1vX2h0dHBfdXJsIiwibW9IdHRwVXJsIiwidm9pY2VfY2FsbGJhY2tfdHlwZSIsInZvaWNlQ2FsbGJhY2tUeXBlIiwidm9pY2VfY2FsbGJhY2tfdmFsdWUiLCJ2b2ljZUNhbGxiYWNrVmFsdWUiLCJ2b2ljZVN0YXR1c0NhbGxiYWNrIiwibnVtYmVyVXBkYXRlIiwibnVtYmVySW5zaWdodCIsImxldmVsIiwiaW5zaWdodEJhc2ljIiwiaW5zaWdodFN0YW5kYXJkIiwidG8iLCJ0ZXh0IiwibWVzc2FnZSIsInNlbmRTbXMiLCJmcm9tIiwiam9pbiIsInByaXZhdGVLZXkiLCJjbGFpbXMiLCJ0b2tlbiIsImVycm9yIiwiZnVsbENsYWltcyIsImZvckVhY2giLCJjbGFpbSIsIm5hbWVWYWx1ZSIsInNwbGl0IiwibGVuZ3RoIiwiRXJyb3IiLCJkZWZpbml0aW9uIiwiZ2VuZXJhdGVKd3QiLCJleCIsImNsaSIsImNyZWF0ZUludGVyZmFjZSIsInByb2Nlc3MiLCJzdGRpbiIsInN0ZG91dCIsInF1ZXN0aW9uIiwiYW5zd2VyIiwidG9TdHJpbmciLCJ0cmltIiwibG9nIiwiZXhpdCIsImNsb3NlIiwiZGVzdHJveSIsImNoYXJBdCIsInN1YnN0ciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7Ozs7Ozs7SUFFTUEsTztBQUNKLG1CQUFZQyxNQUFaLEVBQW9CQyxNQUFwQixFQUE0QkMsUUFBNUIsRUFBc0M7QUFBQTs7QUFDcEMsU0FBS0YsTUFBTCxHQUFnQkEsTUFBaEI7QUFDQSxTQUFLQyxNQUFMLEdBQWdCQSxNQUFoQjtBQUNBLFNBQUtDLFFBQUwsR0FBZ0JBLFFBQWhCO0FBQ0Q7QUFDRDs7OztpQ0FFYUMsRyxFQUFLQyxNLEVBQVFDLEssRUFBTztBQUMvQixXQUFLQyxrQkFBTCxDQUF3QkgsR0FBeEIsRUFBNkJDLE1B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QyxFQUF3Q0QsUUFBUUUsTUFBaEQsQ0FBVjtBQUNBSixRQUFJSyxRQUFKLENBQWF2QixVQUFVLHlDQUF2QixFQUFrRSxVQUFDd0IsTUFBRCxFQUFZO0FBQzVFLFVBQUlBLE9BQU9DLFFBQVAsR0FBa0JDLElBQWxCLE1BQTRCLFNBQWhDLEVBQTJDO0FBQ3pDdEUsZ0JBQVF1RSxHQUFSLENBQVksR0FBWjtBQUNBM0c7QUFDRCxPQUhELE1BR087QUFDTG9HLGdCQUFRUSxJQUFSLENBQWEsQ0FBYjtBQUNEOztBQUVEVixVQUFJVyxLQUFKO0FBQ0FULGNBQVFDLEtBQVIsQ0FBY1MsT0FBZDtBQUNELEtBVkQ7QUFXRDtBQUNGLENBakJEOztBQW1CQSxJQUFJdEcsWUFBWSxTQUFaQSxTQUFZLENBQVNELE1BQVQsRUFBaUI7QUFDL0IsTUFBSSxDQUFDQSxNQUFMLEVBQWE7QUFBRSxXQUFPQSxNQUFQO0FBQWdCO0FBQy9CLFNBQU1BLE9BQU93RyxNQUFQLENBQWMsQ0FBZCxNQUFxQixHQUEzQixFQUFnQztBQUM5QnhHLGFBQVNBLE9BQU95RyxNQUFQLENBQWMsQ0FBZCxDQUFUO0FBQ0Q7QUFDRCxTQUFPekcsTUFBUDtBQUNELENBTkQiLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZWFkbGluZSBmcm9tICdyZWFkbGluZSc7XG5cbmNsYXNzIFJlcXVlc3Qge1xuICBjb25zdHJ1Y3Rvcihjb25maWcsIGNsaWVudCwgcmVzcG9uc2UpIHtcbiAgICB0aGlzLmNvbmZpZyAgID0gY29uZmlnO1xuICAgIHRoaXMuY2xpZW50ICAgPSBjbGllbnQ7XG4gICAgdGhpcy5yZXNwb25zZSA9IHJlc3BvbnNlO1xuICB9XG4gIC8vIEFjY291bnRcblxuICBhY2NvdW50U2V0dXAoa2V5LCBzZWNyZXQsIGZsYWdzKSB7XG4gICAgdGhpcy5fdmVyaWZ5Q3JlZGVudGlhbHMoa2V5LCBzZWNyZXQsIHRoaXMucmVzcG9uc2UuYWNjb3VudFNldHVwKHRoaXMuY29uZmlnLCBrZXksIHNlY3JldCwgZmxhZ3MpLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgX3ZlcmlmeUNyZWRlbnRpYWxzKGtleSwgc2VjcmV0LCBjYWxsYmFjaykge1xuICAgIGxldCBjbGllbnQgPSB0aGlzLmNsaWVudC5pbnN0YW5jZVdpdGgoa2V5LCBzZWNyZXQpO1xuICAgIGNsaWVudC5hY2NvdW50LmNoZWNrQmFsYW5jZShjYWxsYmFjayk7XG4gIH1cblxuICBhY2NvdW50SW5mbygpIHtcbiAgICB0aGlzLnJlc3BvbnNlLmFjY291bnRJbmZvKHRoaXMuY2xpZW50Lmluc3RhbmNlKCkpO1xuICB9XG5cbiAgYWNjb3VudEJhbGFuY2UoKSB7XG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5hY2NvdW50LmNoZWNrQmFsYW5jZSh0aGlzLnJlc3BvbnNlLmFjY291bnRCYWxhbmNlLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgLy8gUHJpY2luZ1xuXG4gIHByaWNlU21zKG51bWJlcikge1xuICAgIG51bWJlciA9IHN0cmlwUGx1cyhudW1iZXIpO1xuICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkubnVtYmVyLmdldFBob25lUHJpY2luZygnc21zJywgbnVtYmVyLCB0aGlzLnJlc3BvbnNlLnByaWNlU21zLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgcHJpY2VWb2ljZShudW1iZXIpIHtcbiAgICBudW1iZXIgPSBzdHJpcFBsdXMobnVtYmVyKTtcbiAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLm51bWJlci5nZXRQaG9uZVByaWNpbmcoJ3ZvaWNlJywgbnVtYmVyLCB0aGlzLnJlc3BvbnNlLnByaWNlVm9pY2UuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gIH1cblxuICBwcmljZUNvdW50cnkoY291bnRyeV9jb2RlKSB7XG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXIuZ2V0UHJpY2luZyhjb3VudHJ5X2NvZGUsIHRoaXMucmVzcG9uc2UucHJpY2VDb3VudHJ5LmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgLy8gTnVtYmVyc1xuXG4gIG51bWJlcnNMaXN0KGZsYWdzKSB7XG4gICAgbGV0IG9wdGlvbnMgPSB7IHNpemU6IDEwMCB9O1xuICAgIGlmIChmbGFncy5wYWdlKSB7IG9wdGlvbnMuaW5kZXggPSBmbGFncy5wYWdlOyB9XG4gICAgaWYgKGZsYWdzLnNpemUpIHsgb3B0aW9ucy5zaXplID0gZmxhZ3Muc2l6ZTsgfVxuXG4gICAgaWYoZmxhZ3MucGF0dGVybikge1xuICAgICAgb3B0aW9ucy5wYXR0ZXJuID0gZmxhZ3MucGF0dGVybjtcbiAgICAgIG9wdGlvbnMuc2VhcmNoX3BhdHRlcm4gPSAxO1xuICAgICAgaWYgKG9wdGlvbnMucGF0dGVyblswXSA9PT0gJyonKSBvcHRpb25zLnNlYXJjaF9wYXR0ZXJuID0gMjtcbiAgICAgIGlmIChvcHRpb25zLnBhdHRlcm4uc2xpY2UoLTEpID09PSAnKicpIG9wdGlvbnMuc2VhcmNoX3BhdHRlcm4gPSAwO1xuICAgIH1cblxuICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkubnVtYmVyLmdldChvcHRpb25zLCB0aGlzLnJlc3BvbnNlLm51bWJlcnNMaXN0KGZsYWdzKS5iaW5kKHRoaXMucmVzcG9uc2UpKTtcbiAgfVxuXG4gIG51bWJlclNlYXJjaChjb3VudHJ5X2NvZGUsIGZsYWdzKSB7XG4gICAgY291bnRyeV9jb2RlID0gY291bnRyeV9jb2RlLnRvVXBwZXJDYXNlKCk7XG5cbiAgICBsZXQgb3B0aW9ucyA9IHsgZmVhdHVyZXM6IFtdLCBzaXplOiAxMDAgfTtcbiAgICBpZiAoZmxhZ3Mudm9pY2UpIHsgb3B0aW9ucy5mZWF0dXJlcy5wdXNoKCdWT0lDRScpOyB9XG4gICAgaWYgKGZsYWdzLnNtcykgeyBvcHRpb25zLmZlYXR1cmVzLnB1c2goJ1NNUycpOyB9XG4gICAgaWYgKGZsYWdzLnBhZ2UpIHsgb3B0aW9ucy5pbmRleCA9IGZsYWdzLnBhZ2U7IH1cbiAgICBpZiAoZmxhZ3Muc2l6ZSkgeyBvcHRpb25zLnNpemUgPSBmbGFncy5zaXplOyB9XG5cbiAgICBpZihmbGFncy5wYXR0ZXJuKSB7XG4gICAgICBvcHRpb25zLnBhdHRlcm4gPSBmbGFncy5wYXR0ZXJuO1xuICAgICAgb3B0aW9ucy5zZWFyY2hfcGF0dGVybiA9IDE7XG4gICAgICBpZiAob3B0aW9ucy5wYXR0ZXJuWzBdID09PSAnKicpIG9wdGlvbnMuc2VhcmNoX3BhdHRlcm4gPSAyO1xuICAgICAgaWYgKG9wdGlvbnMucGF0dGVybi5zbGljZSgtMSkgPT09ICcqJykgb3B0aW9ucy5zZWFyY2hfcGF0dGVybiA9IDA7XG4gICAgfVxuXG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXIuc2VhcmNoKGNvdW50cnlfY29kZSwgb3B0aW9ucywgdGhpcy5yZXNwb25zZS5udW1iZXJTZWFyY2goZmxhZ3MpLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgbnVtYmVyQnV5KG51bWJlck9yUGF0dGVybiwgY29tbWFuZCkge1xuICAgIGlmKGNvbW1hbmQuY291bnRyeV9jb2RlKSB7XG4gICAgICB0aGlzLm51bWJlckJ1eUZyb21TZWFyY2goY29tbWFuZC5jb3VudHJ5X2NvZGUsIG51bWJlck9yUGF0dGVybiwgY29tbWFuZCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgdGhpcy5udW1iZXJCdXlGcm9tTnVtYmVyKG51bWJlck9yUGF0dGVybiwgY29tbWFuZCk7XG4gICAgfVxuICB9XG5cbiAgbnVtYmVyQnV5RnJvbU51bWJlcihudW1iZXIsIGZsYWdzKSB7XG4gICAgbnVtYmVyID0gc3RyaXBQbHVzKG51bWJlcik7XG4gICAgY29uZmlybShgQnV5aW5nICR7bnVtYmVyfS4gVGhpcyBvcGVyYXRpb24gd2lsbCBjaGFyZ2UgeW91ciBhY2NvdW50LmAsIHRoaXMucmVzcG9uc2UuZW1pdHRlciwgZmxhZ3MsICgpID0+IHtcbiAgICAgIHRoaXMuZ2V0Q291bnRyeUNvZGUobnVtYmVyLCBmbGFncywgKGNvdW50cnlfY29kZSkgPT4ge1xuICAgICAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLm51bWJlci5idXkoY291bnRyeV9jb2RlLCBudW1iZXIsIHRoaXMucmVzcG9uc2UubnVtYmVyQnV5RnJvbU51bWJlcihudW1iZXIpLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBudW1iZXJCdXlGcm9tU2VhcmNoKGNvdW50cnlfY29kZSwgcGF0dGVybiwgZmxhZ3MpIHtcbiAgICBsZXQgb3B0aW9ucyA9IHsgZmVhdHVyZXM6IFsnVk9JQ0UnXSB9O1xuXG4gICAgaWYocGF0dGVybikge1xuICAgICAgb3B0aW9ucy5wYXR0ZXJuID0gcGF0dGVybjtcbiAgICAgIG9wdGlvbnMuc2VhcmNoX3BhdHRlcm4gPSAxO1xuICAgICAgaWYgKHBhdHRlcm5bMF0gPT09ICcqJykgb3B0aW9ucy5zZWFyY2hfcGF0dGVybiA9IDI7XG4gICAgICBpZiAocGF0dGVybi5zbGljZSgtMSkgPT09ICcqJykgb3B0aW9ucy5zZWFyY2hfcGF0dGVybiA9IDA7XG4gICAgfVxuXG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXIuc2VhcmNoKGNvdW50cnlfY29kZSwgb3B0aW9ucywgdGhpcy5yZXNwb25zZS5udW1iZXJCdXlGcm9tUGF0dGVybigobnVtYmVyKSA9PiB7XG4gICAgICB0aGlzLm51bWJlckJ1eUZyb21OdW1iZXIobnVtYmVyLCBmbGFncyk7XG4gICAgfSkpO1xuICB9XG5cbiAgbnVtYmVyQ2FuY2VsKG51bWJlciwgZmxhZ3MpIHtcbiAgICBjb25maXJtKCdUaGlzIG9wZXJhdGlvbiBjYW4gbm90IGJlIHJldmVyc2VkLicsIHRoaXMucmVzcG9uc2UuZW1pdHRlciwgZmxhZ3MsICgpID0+IHtcbiAgICAgIHRoaXMuZ2V0Q291bnRyeUNvZGUobnVtYmVyLCBmbGFncywgKGNvdW50cnlfY29kZSkgPT4ge1xuICAgICAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLm51bWJlci5jYW5jZWwoY291bnRyeV9jb2RlLCBudW1iZXIsIHRoaXMucmVzcG9uc2UubnVtYmVyQ2FuY2VsKG51bWJlcikuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEFwcGxpY2F0aW9uc1xuXG4gIGFwcGxpY2F0aW9uc0xpc3QoZmxhZ3MpIHtcbiAgICBsZXQgb3B0aW9ucyA9IHsgcGFnZV9zaXplOiAxMDAgfTtcbiAgICBpZiAoZmxhZ3MucGFnZSkgeyBvcHRpb25zLmluZGV4ID0gZmxhZ3MucGFnZTsgfVxuICAgIGlmIChmbGFncy5zaXplKSB7IG9wdGlvbnMucGFnZV9zaXplID0gZmxhZ3Muc2l6ZTsgfVxuXG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5hcHAuZ2V0KG9wdGlvbnMsIHRoaXMucmVzcG9uc2UuYXBwbGljYXRpb25zTGlzdChmbGFncykuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gIH1cblxuICBhcHBsaWNhdGlvbkNyZWF0ZShuYW1lLCBhbnN3ZXJfdXJsLCBldmVudF91cmwsIGZsYWdzKSB7XG4gICAgbGV0IG9wdGlvbnMgPSB7fTtcbiAgICBpZiAoZmxhZ3MuYW5zd2VyX21ldGhvZCkgeyBvcHRpb25zLmFuc3dlcl9tZXRob2QgPSBmbGFncy5hbnN3ZXJfbWV0aG9kOyB9XG4gICAgaWYgKGZsYWdzLmV2ZW50X21ldGhvZCkgeyBvcHRpb25zLmV2ZW50X21ldGhvZCA9IGZsYWdzLmV2ZW50X21ldGhvZDsgfVxuXG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5hcHAuY3JlYXRlKG5hbWUsIGZsYWdzLnR5cGUsIGFuc3dlcl91cmwsIGV2ZW50X3VybCwgb3B0aW9ucywgdGhpcy5yZXNwb25zZS5hcHBsaWNhdGlvbkNyZWF0ZShmbGFncykpO1xuICB9XG5cbiAgYXBwbGljYXRpb25TaG93KGFwcF9pZCkge1xuICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkuYXBwLmdldChhcHBfaWQsIHRoaXMucmVzcG9uc2UuYXBwbGljYXRpb25TaG93LmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgYXBwbGljYXRpb25VcGRhdGUoYXBwX2lkLCBuYW1lLCBhbnN3ZXJfdXJsLCBldmVudF91cmwsIGZsYWdzKSB7XG4gICAgbGV0IG9wdGlvbnMgPSB7fTtcbiAgICBpZiAoZmxhZ3MuYW5zd2VyX21ldGhvZCkgeyBvcHRpb25zLmFuc3dlcl9tZXRob2QgPSBmbGFncy5hbnN3ZXJfbWV0aG9kOyB9XG4gICAgaWYgKGZsYWdzLmV2ZW50X21ldGhvZCkgeyBvcHRpb25zLmV2ZW50X21ldGhvZCA9IGZsYWdzLmV2ZW50X21ldGhvZDsgfVxuXG4gICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5hcHAudXBkYXRlKGFwcF9pZCwgbmFtZSwgZmxhZ3MudHlwZSwgYW5zd2VyX3VybCwgZXZlbnRfdXJsLCBvcHRpb25zLCB0aGlzLnJlc3BvbnNlLmFwcGxpY2F0aW9uVXBkYXRlLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgYXBwbGljYXRpb25EZWxldGUoYXBwX2lkLCBmbGFncykge1xuICAgIHJldHVybiBjb25maXJtKCdUaGlzIG9wZXJhdGlvbiBjYW4gbm90IGJlIHJldmVyc2VkLicsIHRoaXMucmVzcG9uc2UuZW1pdHRlciwgZmxhZ3MsICgpID0+IHtcbiAgICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkuYXBwLmRlbGV0ZShhcHBfaWQsIHRoaXMucmVzcG9uc2UuYXBwbGljYXRpb25EZWxldGUuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gICAgfSk7XG4gIH1cblxuICBhcHBsaWNhdGlvbk51bWJlcnMoYXBwX2lkLCBmbGFncykge1xuICAgIGxldCBvcHRpb25zID0ge307XG4gICAgaWYgKGZsYWdzLnBhZ2UpIHsgb3B0aW9ucy5pbmRleCA9IGZsYWdzLnBhZ2U7IH1cbiAgICBpZiAoZmxhZ3Muc2l6ZSkgeyBvcHRpb25zLnNpemUgPSBmbGFncy5zaXplOyB9XG5cbiAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLm51bWJlci5nZXQob3B0aW9ucywgdGhpcy5yZXNwb25zZS5hcHBsaWNhdGlvbk51bWJlcnMoYXBwX2lkLCBmbGFncykuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gIH1cblxuICAvLyBsaW5rc1xuXG4gIGxpbmtBcHAobnVtYmVyLCBhcHBfaWQsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBudWxsLCAnYXBwJywgYXBwX2lkKTtcbiAgfVxuXG4gIGxpbmtTbXMobnVtYmVyLCBjYWxsYmFja191cmwsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBjYWxsYmFja191cmwsICdzbXMnLCBudWxsKTtcbiAgfVxuXG4gIGxpbmtUZWwobnVtYmVyLCBvdGhlcl9udW1iZXIsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBudWxsLCAndGVsJywgb3RoZXJfbnVtYmVyLCBmbGFncy52b2ljZV9zdGF0dXNfY2FsbGJhY2spO1xuICB9XG5cbiAgbGlua1NpcChudW1iZXIsIHNpcF91cmksIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBudWxsLCAnc2lwJywgc2lwX3VyaSwgZmxhZ3Mudm9pY2Vfc3RhdHVzX2NhbGxiYWNrKTtcbiAgfVxuXG4gIGxpbmtWeG1sKG51bWJlciwgY2FsYmFja191cmwsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBudWxsLCAndnhtbCcsIGNhbGJhY2tfdXJsLCBmbGFncy52b2ljZV9zdGF0dXNfY2FsbGJhY2spO1xuICB9XG5cbiAgdW5saW5rQXBwKG51bWJlciwgZmxhZ3MpIHtcbiAgICB0aGlzLl9saW5rKG51bWJlciwgZmxhZ3MsIG51bGwsICdhcHAnKTtcbiAgfVxuXG4gIHVubGlua1NtcyhudW1iZXIsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCAnJywgJ3NtcycpO1xuICB9XG5cbiAgdW5saW5rVGVsKG51bWJlciwgZmxhZ3MpIHtcbiAgICB0aGlzLl9saW5rKG51bWJlciwgZmxhZ3MsIG51bGwsICd0ZWwnKTtcbiAgfVxuXG4gIHVubGlua1NpcChudW1iZXIsIGZsYWdzKSB7XG4gICAgdGhpcy5fbGluayhudW1iZXIsIGZsYWdzLCBudWxsLCAnc2lwJyk7XG4gIH1cblxuICB1bmxpbmtWeG1sKG51bWJlciwgZmxhZ3MpIHtcbiAgICB0aGlzLl9saW5rKG51bWJlciwgZmxhZ3MsIG51bGwsICd2eG1sJyk7XG4gIH1cblxuICBudW1iZXJVcGRhdGUobnVtYmVyLCBmbGFncykge1xuICAgIG51bWJlciA9IHN0cmlwUGx1cyhudW1iZXIpO1xuICAgIHRoaXMuZ2V0Q291bnRyeUNvZGUobnVtYmVyLCBmbGFncywgKGNvdW50cnlfY29kZSkgPT4ge1xuICAgICAgbGV0IG9wdGlvbnMgPSB7fTtcbiAgICAgIGlmIChmbGFncy5tb19odHRwX3VybCkgb3B0aW9ucy5tb0h0dHBVcmwgPSBmbGFncy5tb19odHRwX3VybDtcbiAgICAgIGlmIChmbGFncy52b2ljZV9jYWxsYmFja190eXBlKSBvcHRpb25zLnZvaWNlQ2FsbGJhY2tUeXBlID0gZmxhZ3Mudm9pY2VfY2FsbGJhY2tfdHlwZTtcbiAgICAgIGlmIChmbGFncy52b2ljZV9jYWxsYmFja192YWx1ZSkgb3B0aW9ucy52b2ljZUNhbGxiYWNrVmFsdWUgPSBmbGFncy52b2ljZV9jYWxsYmFja192YWx1ZTtcbiAgICAgIGlmIChmbGFncy52b2ljZV9zdGF0dXNfY2FsbGJhY2spIG9wdGlvbnMudm9pY2VTdGF0dXNDYWxsYmFjayA9IGZsYWdzLnZvaWNlX3N0YXR1c19jYWxsYmFjaztcbiAgICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkubnVtYmVyLnVwZGF0ZShjb3VudHJ5X2NvZGUsIG51bWJlciwgb3B0aW9ucywgdGhpcy5yZXNwb25zZS5udW1iZXJVcGRhdGUuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gICAgfSk7XG4gIH1cblxuICBfbGluayhudW1iZXIsIGZsYWdzLCBtb19odHRwX3VybCwgdm9pY2VfY2FsbGJhY2tfdHlwZSwgdm9pY2VfY2FsbGJhY2tfdmFsdWUsIHZvaWNlX3N0YXR1c19jYWxsYmFjaykge1xuICAgIGlmIChmbGFncyA9PSBudWxsKSB7IGZsYWdzID0ge307IH1cbiAgICBudW1iZXIgPSBzdHJpcFBsdXMobnVtYmVyKTtcbiAgICB0aGlzLmdldENvdW50cnlDb2RlKG51bWJlciwgZmxhZ3MsIChjb3VudHJ5X2NvZGUpID0+IHtcbiAgICAgIGxldCBvcHRpb25zID0ge307XG5cbiAgICAgIGlmICh2b2ljZV9jYWxsYmFja190eXBlID09ICdzbXMnKSB7XG4gICAgICAgIG9wdGlvbnMubW9IdHRwVXJsID0gbW9faHR0cF91cmw7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvcHRpb25zLnZvaWNlQ2FsbGJhY2tUeXBlID0gdm9pY2VfY2FsbGJhY2tfdHlwZTtcbiAgICAgICAgaWYgKHZvaWNlX2NhbGxiYWNrX3ZhbHVlKSBvcHRpb25zLnZvaWNlQ2FsbGJhY2tWYWx1ZSA9IHZvaWNlX2NhbGxiYWNrX3ZhbHVlO1xuICAgICAgICBpZiAodm9pY2Vfc3RhdHVzX2NhbGxiYWNrKSBvcHRpb25zLnZvaWNlU3RhdHVzQ2FsbGJhY2sgPSB2b2ljZV9zdGF0dXNfY2FsbGJhY2s7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkubnVtYmVyLnVwZGF0ZShjb3VudHJ5X2NvZGUsIG51bWJlciwgb3B0aW9ucywgdGhpcy5yZXNwb25zZS5udW1iZXJVcGRhdGUuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gICAgfSk7XG4gIH1cblxuICAvLyBJbnNpZ2h0XG5cbiAgaW5zaWdodEJhc2ljKG51bWJlcikge1xuICAgIG51bWJlciA9IHN0cmlwUGx1cyhudW1iZXIpO1xuICAgIHRoaXMuY2xpZW50Lmluc3RhbmNlKCkubnVtYmVySW5zaWdodC5nZXQoe2xldmVsOiAnYmFzaWMnLCBudW1iZXI6IG51bWJlcn0sIHRoaXMucmVzcG9uc2UuaW5zaWdodEJhc2ljLmJpbmQodGhpcy5yZXNwb25zZSkpO1xuICB9XG5cbiAgaW5zaWdodFN0YW5kYXJkKG51bWJlciwgZmxhZ3MpIHtcbiAgICBudW1iZXIgPSBzdHJpcFBsdXMobnVtYmVyKTtcbiAgICBjb25maXJtKCdUaGlzIG9wZXJhdGlvbiB3aWxsIGNoYXJnZSB5b3VyIGFjY291bnQuJywgdGhpcy5yZXNwb25zZS5lbWl0dGVyLCBmbGFncywgKCkgPT4ge1xuICAgICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5udW1iZXJJbnNpZ2h0LmdldCh7bGV2ZWw6ICdzdGFuZGFyZCcsIG51bWJlcjogbnVtYmVyfSwgdGhpcy5yZXNwb25zZS5pbnNpZ2h0U3RhbmRhcmQuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gICAgfSk7XG4gIH1cblxuICBpbnNpZ2h0QWR2YW5jZWQobnVtYmVyLCBmbGFncykge1xuICAgIG51bWJlciA9IHN0cmlwUGx1cyhudW1iZXIpO1xuICAgIGNvbmZpcm0oJ1RoaXMgb3BlcmF0aW9uIHdpbGwgY2hhcmdlIHlvdXIgYWNjb3VudC4nLCB0aGlzLnJlc3BvbnNlLmVtaXR0ZXIsIGZsYWdzLCAoKSA9PiB7XG4gICAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLm51bWJlckluc2lnaHQuZ2V0KHtsZXZlbDogJ2FkdmFuY2VkU3luYycsIG51bWJlcjogbnVtYmVyfSwgdGhpcy5yZXNwb25zZS5pbnNpZ2h0U3RhbmRhcmQuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gICAgfSk7XG4gIH1cblxuICAvLyBzZW5kaW5nIG1lc3NhZ2VzXG5cbiAgc2VuZFNtcyh0bywgdGV4dCwgZmxhZ3MpIHtcbiAgICBjb25maXJtKCdUaGlzIG9wZXJhdGlvbiB3aWxsIGNoYXJnZSB5b3VyIGFjY291bnQuJywgdGhpcy5yZXNwb25zZS5lbWl0dGVyLCBmbGFncywgKCkgPT4ge1xuICAgICAgdGhpcy5jbGllbnQuaW5zdGFuY2UoKS5tZXNzYWdlLnNlbmRTbXMoZmxhZ3MuZnJvbSwgdG8sIHRleHQuam9pbignICcpLCB0aGlzLnJlc3BvbnNlLnNlbmRTbXMuYmluZCh0aGlzLnJlc3BvbnNlKSk7XG4gICAgfSk7XG4gIH1cblxuICBnZW5lcmF0ZUp3dChwcml2YXRlS2V5LCBjbGFpbXMsIGZsYWdzKSB7XG4gICAgbGV0IHRva2VuID0gbnVsbDtcbiAgICBsZXQgZXJyb3IgPSBudWxsO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZ1bGxDbGFpbXMgPSB7fTtcbiAgICAgIGlmKGZsYWdzLmFwcF9pZCkge1xuICAgICAgICBmdWxsQ2xhaW1zWydhcHBsaWNhdGlvbl9pZCddID0gZmxhZ3MuYXBwX2lkO1xuICAgICAgfVxuXG4gICAgICBjbGFpbXMuZm9yRWFjaCgoY2xhaW0pID0+IHtcbiAgICAgICAgbGV0IG5hbWVWYWx1ZSA9IGNsYWltLnNwbGl0KCc9Jyk7XG4gICAgICAgIGlmKG5hbWVWYWx1ZS5sZW5ndGggIT09IDIpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FsbCBjbGFpbXMgbXVzdCBiZSBpbiB0aGUgZm9ybSBgbmFtZT12YWx1ZWAuIEdvdDogJyArIG5hbWVWYWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgZnVsbENsYWltc1sgbmFtZVZhbHVlWzBdIF0gPSBuYW1lVmFsdWVbMV07XG4gICAgICB9KTtcblxuICAgICAgdG9rZW4gPSB0aGlzLmNsaWVudC5kZWZpbml0aW9uKCkuZ2VuZXJhdGVKd3QocHJpdmF0ZUtleSwgZnVsbENsYWltcyk7XG4gICAgfVxuICAgIGNhdGNoKGV4KSB7XG4gICAgICBlcnJvciA9IGV4O1xuICAgIH1cbiAgICB0aGlzLnJlc3BvbnNlLmdlbmVyYXRlSnd0KGVycm9yLCB0b2tlbik7XG4gIH1cblxuICBnZXRDb3VudHJ5Q29kZShudW1iZXIsIGZsYWdzLCBjYWxsYmFjaykge1xuICAgIGlmIChmbGFncy5jb3VudHJ5X2NvZGUpIHsgXG4gICAgICBjYWxsYmFjayhmbGFncy5jb3VudHJ5X2NvZGUpOyBcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0aGlzLmNsaWVudC5pbnN0YW5jZSgpLm51bWJlckluc2lnaHQuZ2V0KHtsZXZlbDogJ2Jhc2ljJywgbnVtYmVyOiBudW1iZXJ9LCB0aGlzLnJlc3BvbnNlLm51bWJlckluc2lnaHQoKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgIGNhbGxiYWNrKHJlc3BvbnNlLmNvdW50cnlfY29kZSk7XG4gICAgICB9KSk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFJlcXVlc3Q7XG5cbi8vIHByaXZhdGUgbWV0aG9kc1xuXG5sZXQgY29uZmlybSA9IGZ1bmN0aW9uKG1lc3NhZ2UsIGVtaXR0ZXIsIGZsYWdzLCBjYWxsYmFjaykge1xuICBpZiAoZmxhZ3MuY29uZmlybSkge1xuICAgIGNhbGxiYWNrKCk7XG4gIH0gZWxzZSB7XG4gICAgbGV0IGNsaSA9IHJlYWRsaW5lLmNyZWF0ZUludGVyZmFjZShwcm9jZXNzLnN0ZGluLCBwcm9jZXNzLnN0ZG91dCk7XG4gICAgY2xpLnF1ZXN0aW9uKG1lc3NhZ2UgKyAnXFxuXFxuUGxlYXNlIHR5cGUgXCJjb25maXJtXCIgdG8gY29udGludWU6ICcsIChhbnN3ZXIpID0+IHtcbiAgICAgIGlmIChhbnN3ZXIudG9TdHJpbmcoKS50cmltKCkgPT0gJ2NvbmZpcm0nKSB7XG4gICAgICAgIGVtaXR0ZXIubG9nKCcgJyk7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICB9XG5cbiAgICAgIGNsaS5jbG9zZSgpO1xuICAgICAgcHJvY2Vzcy5zdGRpbi5kZXN0cm95KCk7XG4gICAgfSk7XG4gIH1cbn07XG5cbmxldCBzdHJpcFBsdXMgPSBmdW5jdGlvbihudW1iZXIpIHtcbiAgaWYgKCFudW1iZXIpIHsgcmV0dXJuIG51bWJlcjsgfVxuICB3aGlsZShudW1iZXIuY2hhckF0KDApID09PSAnKycpIHtcbiAgICBudW1iZXIgPSBudW1iZXIuc3Vic3RyKDEpO1xuICB9XG4gIHJldHVybiBudW1iZXI7XG59O1xuXG4iXX0=